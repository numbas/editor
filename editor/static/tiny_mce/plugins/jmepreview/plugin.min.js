/**
 * plugin.js
 *
 * Released under LGPL License.
 * Copyright (c) 1999-2015 Ephox Corp. All rights reserved
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */

/*global tinymce:true */

tinymce.PluginManager.add('jmepreview', function(editor) {
	var settings = editor.settings, sandbox = false && !tinymce.Env.ie;

    function make_preview() {
        var container = document.querySelector('#previewModal .preview-content');

        var scope = new Numbas.jme.Scope([viewModel.questionScope()]);
        scope.showSubstitutions = true;

        Numbas.display_util.set_jme_scope(container, scope);

        container.innerHTML = editor.getContent({keepGapfills:true});

        Numbas.jme.variables.DOMcontentsubvars(container, scope);

        mathjax_typeset_element(container);
    }

	editor.addCommand('mceJMEPreview', function() {
        $('#previewModal')
            .modal('show')
            .on('hide.bs.modal',function() {
                $('#previewModal .regenerate-button').off('click');
            })
        ;
        $('#previewModal .regenerate-button')
            .on('click',function() {
                viewModel.generateVariablePreview();
                make_preview();
            })
        ;
        make_preview();

        return;
	});

	editor.addButton('preview', {
		title: 'Preview',
		cmd: 'mceJMEPreview'
	});

	editor.addMenuItem('preview', {
		text: 'Preview',
		cmd: 'mceJMEPreview',
		context: 'view'
	});
});

