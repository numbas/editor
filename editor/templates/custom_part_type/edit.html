{% extends "layout.html" %}
{% load user_link %}
{% load can_edit %}
{% load links %}
{% load sanitizer %}
{% load helplink %}
{% load editor_controls %}
{% load sstatic %}
{% load json_filter %}

{% block title %}{{object.name}} - Custom part type - {{block.super}}{% endblock %}

{% block body_classes %}{{block.super}} custom-part-type-editor{% endblock %}

{% block stylesheets %}
    {{block.super}}
    <link href="{% sstatic 'css/custom_part_type/edit.css' %}" type="text/css" rel="stylesheet" />
{% endblock %}

{% block javascripts %}
    {{block.super}}

    {% include 'numbas_runtime.html' %}

    <script type="text/javascript">
        $(document).ready(function() {
            Editor.custom_part_type = {};
        });
    </script>

    <script type="text/javascript">
        (function() {
            window.item_json = {{item_json|json|safe}};
        })();
    </script>

    <script src="{% sstatic 'js/custom_part_type/edit.js' %}"></script>
{% endblock %}

{% block content_container %}container-fluid{% endblock %}

{% block content %}
<template id="choice-maker-template">
    <ul class="list-unstyled" data-bind="foreach: model.choices">
        <li>
            <div class="form-group">
                <button type="button" class="btn btn-link" data-bind="click: $component.model.delete_choice" title="Delete this choice"><span class="text-danger glyphicon glyphicon-remove"></span></button>
                <!-- ko if: $parent.useValues -->
                <label class="col-xs-12 col-sm-6" data-bind="css: {'has-error': !value()}">
                    Value
                    {% text_input 'value' monospace=True %}
                </label>
                <label class="col-xs-12 col-sm-6" data-bind="css: {'has-error': !label()}">
                    Label
                    {% text_input 'label' %}
                </label>
                <!-- /ko -->
                <!-- ko ifnot: $parent.useValues -->
                <label class="" data-bind="css: {'has-error': !label()}">
                    {% text_input 'label' %}
                </label>
                <!-- /ko -->
            </div>
        </li>
    </ul>
    <!-- ko if: !ko.unwrap(disable) -->
    <div data-bind="visible: !valid()" class="alert alert-danger">
        <p data-bind="visible: model.choices().length==0">Add at least one choice.</p>
        <p data-bind="visible: model.choices().length && model.valid_choices().length<model.choices().length">Complete every choice.</p>
    </div>
    <button type="button" class="btn btn-primary" data-bind="click: model.add_choice">
        <span class="glyphicon glyphicon-plus"></span> <span data-bind="text: model.choices().length ? 'Add another choice' : 'Add a choice'"></span>
    </button>
    <!-- /ko -->
</template>

<div class="page-loading" data-bind="visible: false">
    <h1>Loading...</h1>
</div>

<div class="page-error">
    <div class="page-header text-danger">
        <h2>Error</h2>
    </div>
    <p class="text-lg">There was an error loading the page.</p>

    <pre class="trace"></pre>
</div>
<div class="loaded-content">
    <div class="page-header">
        {% block page_header %}
        <a class="back" href="{% url 'profile_custom_part_types' request.user.pk %}">Back to custom part types</a>
        <h1 class="name-header">
            <span class="glyphicon glyphicon-ok"></span> 
            <span class="name" data-bind="mathjaxHTML: name"></span>
            {% if editable %}
            <button type="button" class="btn btn-link" title="Change this part type's name" data-bind="click: edit_name"><span class="glyphicon glyphicon-pencil"></span></button>
            {% endif %}
        </h1>
        <div class="save-status alert" data-bind="class: autoSave.status_info().class">
            <span class="glyphicon" data-bind="class: autoSave.status_info().icon"></span>
            <span data-bind="text: autoSave.status_info().message">Saved</span>
        </div>
        {% endblock page_header %}
    </div>
    <div class="navbar navbar-blank">
        <ul class="nav navbar-nav nav-tabs">
            <li class="dropdown single-button">
                <div class="btn-group">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="organisation-dropdown-button">
                        Organisation
                        <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" aria-labelledBy="organisation-dropdown-button">
                        {% with can_copy=object|can_be_copied_by:request.user %}
                        <li class="{% if not can_copy %}disabled{% endif %}">
                            <a href="{% if can_copy %}{% url 'custom_part_type_copy' object.pk %}{% endif %}" target="_blank" title="{% if can_copy %}Create your own copy of this part type{% else %}This item's licence doesn't allow you to modify it.{% endif %}">
                                <span class="text-warning">
                                    <span class="glyphicon glyphicon-duplicate"></span>
                                    Make a copy
                                </span>
                            </a>
                        </li>
                        {% endwith %}

                        {% if editable %}
                        <li class="{% if not editable %}disabled{% endif %}">
                            <a href="{% url 'custom_part_type_delete' object.pk %}" title="Delete this part type permanently">
                                <span class="text-danger">
                                    <span class="glyphicon glyphicon-remove"></span> 
                                    Delete
                                </span>
                            </a>
                        </li>
                        {% endif %}

                        <li role="separator" class="divider"></li>

                        <li>
                        <a href="{% url 'custom_part_type_source' object.pk %}">
                            <span class="glyphicon glyphicon-cloud-download"></span>
                            Download
                        </a>
                        </li>

                        <li>
                        <a href="{% url 'custom_part_type_reupload' object.pk %}">
                            <span class="glyphicon glyphicon-cloud-upload"></span>
                            Re-upload
                        </a>
                        </li>
                    </ul>
                </div>
            </li>
            <!-- ko foreach: mainTabber.tabs -->
            <li data-bind="visible: visible, css: {active: $root.mainTabber.currentTab() == $data}">
                <a href="#" data-bind="click: $root.mainTabber.currentTab">
                    <span data-bind="attr: {'class': 'glyphicon glyphicon-'+icon, title: title}"></span> 
                    <span class="tab-label hidden-sm" data-bind="text: title"></span>
                </a>
            </li>
            <!-- /ko -->
        </ul>
    </div>

    <div class="row">
        <div class="col-sm-12 editing">
            <div class="tab-content">
            {% block main_tab_content %}
                <!-- Description -->
                <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.mainTabber.currentTab().id)=='description'}">
                    <div class="form-group name">
                        <label>Name</label>
                        <input id="name-input" {% if not editable %}disabled{% endif %} class="form-control input-lg" data-bind="textInput: name">
                    </div>

                    <div class="form-group description">
                        <label>Description</label>
                        <div id="description-input" {% if not editable %}disabled{% endif %} data-bind="writemaths: description"></div>
                        {% if editable %}
                        <p class="help-block">
                            {% helplink 'custom-part-types/reference.html#term-Description' subject='the description field' %}
                            Describe how this part type works, and what kinds of questions it is appropriate for.
                        </p>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        {% if editable %}
                            <label>URL of documentation</label>
                            <input class="form-control" data-bind="textInput: help_url">
                            <p class="help-block">
                                {% helplink 'custom-part-types/reference.html#term-URL-of-documentation' subject='the URL of documentation field' %}
                                Provide a link to any more documentation about your custom part type.
                            </p>
                        {% else %}
                            {% if object.help_url %}
                                <a class="helplink" href="{{object.help_url}}" target="_blank"><span class="glyphicon glyphicon-question-sign"></span> Documentation for this part type</a>
                            {% endif %}
                        {% endif %}
                    </div>

                    {% if editable %}
                    <editor-pager params="editor: $root, nextTab: 'settings', task_group: 'description'"></editor-pager>
                    {% endif %}
                </section>

                <!-- Required extensions -->
                <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.mainTabber.currentTab().id)=='extensions'}">
                    <div class="form-group">
                        <p class="help-block">
                            Select any extensions that are required for this part to work.
                        </p>
                        <ul class="extensions" data-bind="foreach: extensions">
                            <li class="extension" data-bind="css: {error: error, 'text-warning': error}">
                                <label>
                                    <span class="checkbox"><input type="checkbox" data-bind="checked: used, disable: !item_json.editable || error()"></span>
                                    <span data-bind="text:name"></span> 
                                    <a data-bind="if: url, attr: {href:url, title: 'Documentation on the '+name+' extension'}" target="_blank"><small class="glyphicon glyphicon-book"></small></a>
                                    {% if not user.is_anonymous %}<a data-bind="if: author=={{user.pk}}, attr: {href: edit_url, title: 'Edit the '+name+' extension'}" target="_blank"><small class="glyphicon glyphicon-pencil"></small></a>{% endif %}
                                    <span class="text-warning" data-bind="fadeVisible: loading">Loading...</span>
                                </label>
                                <div class="text-warning" data-bind="fadeVisible: error">
                                    There was an error loading this extension.
                                </div>
                            </li>
                        </ul>
                    </div>
                </section>

                <!-- Part settings -->
                <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.mainTabber.currentTab().id)=='settings'}">
                    <p><a target="numbasquickhelp" href="{{HELP_URL}}custom-part-types/reference.html#part-settings"><span class="glyphicon glyphicon-question-sign"></span> Help with part settings</a></p>
                    <ul class="list-unstyled" data-bind="foreach: settings">
                        <li>
                            <div class="panel" data-bind="css: {'panel-default': valid(), 'panel-warning': !valid()}">
                                <div class="panel-heading">
                                    <div class="pull-right">
                                        <div class="btn-group">
                                            {% if editable %}
                                            <button type="button" class="btn btn-link" data-bind="click: moveUp, visible: canMove('up')" title="Move this setting up one place"><span class="glyphicon glyphicon-arrow-up"></span></button>
                                            <button type="button" class="btn btn-link" data-bind="click: moveDown, visible: canMove('down')" title="Move this setting down one place"><span class="glyphicon glyphicon-arrow-down"></span></button>
                                            {% endif %}
                                        </div>
                                        {% if editable %}
                                        <button type="button" class="btn btn-link" data-bind="click: $parent.remove_setting" title="Remove this setting"><span class="glyphicon glyphicon-remove text-danger"></span></button>
                                        {% endif %}
                                    </div>

                                    <span data-bind="visible: label"><strong data-bind="text: label"></strong> (<span data-bind="text: input_type().niceName"></span>)</span>
                                    <span data-bind="visible: !label()"><span data-bind="text: input_type().niceName"></span></span>
                                </div>
                                <div class="panel-body">
                                    <form class="form-horizontal" data-bind="submit: Editor.noop">
                                        {% property 'name' 'Name' monospace=True warning='nameError' %}
                                        {% property 'label' 'Label' warning='!label() ? \'A label is required\' : \'\'' %}
                                        {% property 'help_url' 'Help URL' monospace=True %}
                                        <!-- ko with: input_type -->

                                        <!-- ko if: $parent.input_type().name == 'string' -->
                                        {% property 'model.default_value' 'Default value' %}
                                        {% booleanproperty 'model.subvars' 'Substitute variables into value?' %}
                                        <!-- /ko -->

                                        <!-- ko if: $parent.input_type().name == 'mathematical_expression' -->
                                        {% jmeproperty 'model.default_value' 'Default value' %}
                                        {% booleanproperty 'model.subvars' 'Substitute variables into value?' %}
                                        <!-- /ko -->

                                        <!-- ko if: $parent.input_type().name == 'checkbox' -->
                                        {% booleanproperty 'model.default_value' 'Default value' %}
                                        <!-- /ko -->

                                        <!-- ko if: $parent.input_type().name == 'dropdown' -->
                                        <div class="form-group">
                                            <label class="label-block">
                                                <div class="{{form_label_class}} control-label">
                                                    Choices
                                                </div>
                                            </label>
                                            <div class="{{form_control_class}}">
                                                <choice-maker params="model: model.choice_maker{% if not editable %}, disable: true{% endif %}"></choice-maker>
                                            </div>
                                        </div>
                                        <!-- ko if: model.choice_maker.valid_choices().length>0 -->
                                        {% selectproperty 'model.default_value' 'Default value' options_text='label' options='model.choice_maker.valid_choices' %}
                                        <!-- /ko -->
                                        <!-- /ko -->

                                        <!-- ko if: $parent.input_type().name == 'choose_several' -->
                                        <div class="form-group">
                                            <label class="label-block">
                                                <div class="{{form_label_class}} control-label">
                                                    Choices
                                                </div>
                                            </label>
                                            <div class="{{form_control_class}}">
                                                <ul class="list-unstyled" data-bind="foreach: model.choices">
                                                    <li>
                                                        <div class="form-group">
                                                            <label class="col-xs-12 col-sm-4" data-bind="css: {'has-error': !value()}">
                                                                Value
                                                                {% text_input 'value' monospace=True %}
                                                            </label>
                                                            <label class="col-xs-12 col-sm-6" data-bind="css: {'has-error': !label()}">
                                                                Label
                                                                {% text_input 'label' %}
                                                            </label>
                                                            <label class="col-xs-12 col-sm-2">
                                                                Default on?
                                                                {% boolean_input 'default_value' %}
                                                            </label>
                                                        </div>
                                                    </li>
                                                </ul>
                                                {% if editable %}
                                                <div data-bind="visible: !valid()" class="alert alert-danger">
                                                    <p data-bind="visible: model.choices().length==0">Add at least one choice.</p>
                                                    <p data-bind="visible: model.choices().length && model.valid_choices().length<model.choices().length">Complete every choice.</p>
                                                </div>
                                                <button type="button" class="btn btn-primary" data-bind="click: model.add_choice">
                                                    <span class="glyphicon glyphicon-plus"></span> <span data-bind="text: model.choices().length ? 'Add another choice' : 'Add a choice'"></span>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <!-- /ko -->

                                        <!-- ko if: $parent.input_type().name == 'code' -->
                                        <div class="form-group">
                                            <label class="label-block">
                                                <div class="{{form_label_class}} control-label">
                                                    Default value
                                                </div>
                                            </label>
                                            <div class="{{form_control_class}}">
                                                <textarea {% if not editable %}disabled{% endif %} class="def" data-bind="codemirror: model.default_value, codemirrorMode: 'jme'"></textarea>
                                            </div>
                                        </div>
                                        {% booleanproperty 'model.evaluate' 'Evaluate?' %}
                                        <!-- /ko -->

                                        <!-- ko if: $parent.input_type().name == 'percent' -->
                                        {% percentproperty 'model.default_value' 'Default value' %}
                                        <!-- /ko -->

                                        <!-- ko if: $parent.input_type().name == 'html' -->
                                        <div class="form-group">
                                            <label class="label-block">
                                                <div class="{{form_label_class}} control-label">
                                                    Default value
                                                </div>
                                            </label>
                                            <div class="{{form_control_class}}">
                                                <div {% if not editable %}disabled{% endif %} data-bind="writemaths: model.default_value"></div>
                                            </div>
                                        </div>
                                        {% booleanproperty 'model.subvars' 'Substitute variables into value?' %}
                                        <!-- /ko -->

                                        <!-- ko if: $parent.input_type().name == 'list_of_strings' -->
                                        <div class="form-group">
                                            <label class="label-block">
                                                <div class="{{form_label_class}} control-label">
                                                    Default value
                                                </div>
                                            </label>
                                            <div class="{{form_control_class}}">
                                                <listbox params="items: model.default_value{% if not editable %}, disabled: true{% endif %}"></listbox>
                                            </div>
                                        </div>
                                        {% booleanproperty 'model.subvars' 'Substitute variables into value?' %}
                                        <!-- /ko -->

                                        <!-- /ko -->

                                        <div class="form-group">
                                            <label class="label-block">
                                                <div class="{{form_label_class}} control-label">
                                                    Input hint for question author
                                                </div>
                                            </label>
                                            <div class="{{form_control_class}}">
                                                <div {% if not editable %}disabled{% endif %} data-bind="writemaths: hint, wmPara: false"></div>
                                                {% if editable %}
                                                <p class="help-block">
                                                    Describe how this setting should be used.
                                                </p>
                                                {% endif %}
                                            </div>
                                        </div>

                                    </form>
                                </div>
                            </div>
                        </li>
                    </ul>
                    {% if editable %}
                    <div class="btn-group">
                        <button id="add-setting-button" type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-bind="css: {'btn-lg': settings().length==0}">
                            <span class="glyphicon glyphicon-plus"></span> <span data-bind="text: settings().length ? 'Add another setting' : 'Add a setting'"></span> <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" data-bind="foreach: Editor.custom_part_type.setting_types">
                            <li><a href="#" data-bind="click: $parent.add_setting, text: niceName"></a></li>
                        </ul>
                    </div>
                    {% endif %}

                    {% if editable %}
                    <editor-pager params="editor: $root, previousTab: 'description', nextTab: 'input', task_group: 'settings'"></editor-pager>
                    {% endif %}
                </section>

                <!-- Answer input -->
                <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.mainTabber.currentTab().id)=='input'}">
                    <p><a target="numbasquickhelp" href="{{HELP_URL}}custom-part-types/reference.html#answer-input"><span class="glyphicon glyphicon-question-sign"></span> Help with answer input methods</a></p>
                    <form class="form-horizontal" data-bind="submit: Editor.noop">
                        {% selectproperty 'input_widget' 'Answer input method' options_text='niceName' options='input_widgets' help_url='custom-part-types/reference.html#answer-input-methods' %}

                        <div class="form-group">
                            <label class="{{form_label_class}} control-label">
                                Expected answer
                                {% helplink 'custom-part-types/reference.html#term-Expected-answer' subject='the expected answer field' %}
                            </label>
                            <div class="{{form_control_class}}">
                                <textarea {% if not editable %}disabled{% endif %} data-bind="codemirror: input_options.correctAnswer, codemirrorMode: 'jme'"></textarea>
                                <undefined-variable-warning params="expr: input_options.correctAnswer, vars: ['settings']"></undefined-variable-warning>
                                {% if editable %}
                                <p class="help-block">
                                    An expression which evaluates to the expected answer to the part. You can refer to any of the part's settings.
                                </p>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="{{form_label_class}} control-label">
                                Input hint
                                {% helplink 'custom-part-types/reference.html#term-Input-hint' subject='the input hint field' %}
                            </label>
                            <div class="{{form_control_class}}">
                                <static-dynamic-setting params="option: input_options.hint, type_hint: 'string'{% if not editable %}, disable: true{% endif %}">
                                    {% text_input 'static_value' %}
                                </static-dynamic-setting>
                                {% if editable %}
                                <p class="help-block">
                                    Give the student any necessary information about how to enter their answer.
                                </p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- ko foreach: input_widget().settings -->
                        <div class="form-group">
                            <label class="label-block">
                                <div class="{{form_label_class}} control-label">
                                    <span data-bind="text: label"></span>
                                    <span data-bind="if: help_url">
                                        <a class="helplink text-info" target="numbasquickhelp" data-bind="attr: {href: help_url, title: 'Help on '+ko.unwrap(label)}"><small class="glyphicon glyphicon-question-sign"></small></a>
                                    </span>
                                </div>
                                <div class="{{form_control_class}}">
                                    <static-dynamic-setting params="option: value, type_hint: type_hint{% if not editable %}, disable: true{% endif %}">
                                        <!-- ko with: $parent -->
                                        <div data-bind="if: input_type=='number_notation_styles'">
                                            <multi-select-checkboxes params="{% if not editable %}disabled: true, {%endif%}options: Editor.numberNotationStyles, selectedOptions: value.static_value, labelProperty: 'name', helpProperty: 'description'"></muli-select-checkboxes>
                                        </div>
                                        <div data-bind="if: input_type=='string'">
                                            <input {% if not editable %}disabled{% endif%} class="form-control" type="text" data-bind="
                                                textInput: value.static_value, 
                                                autosize: {max: 500, min: 30, padding: 10, value: value.static_value }
                                            "/>
                                        </div>
                                        <div data-bind="if: input_type=='mathematical_expression'">
                                            <input {% if not editable %}disabled{% endif %} class="monospace form-control" type="text" data-bind="textInput: value.static_value, autosize: {max: 500, min: 30, padding: 10, value: value.static_value}"/>
                                            <span data-bind="JME: value.static_value" class="jme-answer"></span>
                                        </div>
                                        <div data-bind="if: input_type=='checkbox'">
                                            <div class="checkbox">
                                                <input {% if not editable %}disabled{% endif %} type="checkbox" data-bind="checked: value.static_value">
                                            </div>
                                        </div>
                                        <div data-bind="if: input_type=='dropdown'">
                                            <select {% if not editable %}disabled{% endif%} class="form-control" data-bind="value: value.static_value, foreach: data.choices">
                                                <option data-bind="value: value, text: label"></option>
                                            </select>
                                        </div>
                                        <div data-bind="if: input_type=='code'">
                                            <textarea {% if not editable %}disabled{% endif %} data-bind="codemirror: value.static_value, codemirrorMode: 'jme'"></textarea>
                                        </div>
                                        <div data-bind="if: input_type=='percent'">
                                            <input
                                                {% if not editable %}disabled{% endif%} 
                                                data-bind="value: value.static_value"
                                                type="range"
                                                step="5"
                                                min="0"
                                                max="100"
                                            />
                                            <span class="percentproperty value" data-bind="text: ko.unwrap(value.static_value)+'%'"></span>
                                        </div>
                                        <div data-bind="if: input_type=='html'">
                                            <div {% if not editable %}disabled{% endif %} data-bind="writemaths: value.static_value, wmPara: false, tinymce_plugins: ['jmevisible','jmepreview']"></div>
                                        </div>
                                        <div data-bind="if: input_type=='list_of_strings'">
                                            <listbox params="items: value.static_value{% if not editable %}, disabled: true{% endif %}"></listbox>
                                        </div>
                                        <div data-bind="if: input_type=='choose_several'">
                                            <multi-select-checkboxes params="options: data.choices, valueName: 'value', selectedOptions: value.static_value, labelProperty: 'label', helpProperty: 'hint'"></muli-select-checkboxes>
                                        </div>
                                        <div data-bind="if: input_type=='choice_maker'">
                                            <choice-maker params="model: value.static_value"></choice-maker>
                                        </div>
                                        <!-- /ko -->
                                    </static-dynamic-setting>
                                </div>
                            </label>
                        </div>
                        <!-- /ko -->
                    </form>

                    {% if editable %}
                    <editor-pager params="editor: $root, previousTab: 'settings', nextTab: 'marking', task_group: 'input'"></editor-pager>
                    {% endif %}
                </section>

                <!-- Marking algorithm -->
                <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.mainTabber.currentTab().id)=='marking'}">
                    <p><a target="numbasquickhelp" href="{{HELP_URL}}custom-part-types/reference.html#marking"><span class="glyphicon glyphicon-question-sign"></span> Help with marking</a></p>
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-sm-12 col-md-8 col-lg-9" data-bind="visible: marking_notes().length==0">
                                <p class="nothing-here">No marking notes have been defined.</p>
                            </div>
                            <div class="col-sm-12 col-md-8 col-lg-9 note-definition" data-bind="visible: marking_notes().length, with: current_marking_note">
                                <form data-bind="submit: Editor.noop">
                                    <div class="form-group">
                                        <label>Name</label>
                                        <input {% if not editable %}disabled{% endif %} type="text" placeholder="Name" class="form-control name monospace" data-bind="textInput: _name, disable: required"/>
                                        <p class="help-block" data-bind="visible: required">This note is required.</p>
                                        <span class="name-error text-danger" data-bind="text: nameError, visible: nameError"></span>
                                    </div>
                                    <div class="form-group">
                                        <label>Definition</label>
                                        <textarea {% if not editable %}disabled{% endif %} class="definition" data-bind="codemirror: definition"></textarea>
                                        <undefined-variable-warning params="expr: definition, vars: $parent.marking_defined_names, show_syntax_errors: false"></undefined-variable-warning>
                                        <div class="alert alert-danger" data-bind="visible: definitionError" aria-live="polite">
                                            <p data-bind="html: definitionError"></p>
                                        </div>
                                        <p class="help-block text-right">
                                            <a class="helplink text-info" href="{{HELP_URL}}jme-reference.html" target="_blank">JME function reference <span class="glyphicon glyphicon-question-sign"></span></a>
                                        </p>
                                    </div>
                                    <div class="form-group">
                                        <label>Description</label>
                                        <div data-bind="visible: !required(), writemaths: description"></div>
                                        <div data-bind="visible: required, html: description"></div>
                                    </div>

                                </form>

                                <div data-bind="visible: dependencies().length>0" class="inline-names">
                                    <label>← Depends on:</label>
                                    <ul class="list-inline" data-bind="foreach: dependencies">
                                        <li><span class="btn btn-sm monospace" data-bind="click: go_to, text: name, css: {'btn-warning': !exists, 'btn-info': exists}, attr: {title: title}"></span></li>
                                    </ul>
                                </div>
                                <div data-bind="visible: used_by().length>0" class="inline-names">
                                    <label>→ Used by:</label>
                                    <ul class="list-inline" data-bind="foreach: used_by">
                                        <li><span class="btn btn-sm btn-info monospace" data-bind="click: $parents[1].current_marking_note, text: name"></span></li>
                                    </ul>
                                </div>
                            </div>

                            <div class="col-sm-12 col-md-4 col-lg-3">
                                <div class="panel panel-info">
                                    <div class="panel-heading">
                                        <h3 class="panel-title">Marking notes</h3>
                                    </div>
                                    <ul class="marking-notes list-group list-group-hover" data-bind="sortable: {foreach: marking_notes, group: 'marking_notes'}">
                                        <li class="list-group-item" data-bind="css: {active: $data == $parent.current_marking_note(), danger: !valid()}, click: $parent.current_marking_note">
                                            <button type="button" class="pull-right btn btn-link" data-bind="visible: !required(), click: $parent.remove_marking_note" title="Remove this marking note"><span class="glyphicon glyphicon-remove text-danger"></span></button>
                                            <span data-bind="css: {monospace: name()}, text: name() || 'Unnamed note'"></span>
                                        </li>
                                    </ul>
                                    <div class="panel-footer">
                                        {% if editable %}
                                        <button type="button" class="btn btn-default add-marking-note" data-bind="click: add_marking_note">
                                            <span class="glyphicon glyphicon-plus"></span>
                                            Add a marking note
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if editable %}
                    <editor-pager params="editor: $root, previousTab: 'input', nextTab: 'access', task_group: 'marking'"></editor-pager>
                    {% endif %}
                </section>

                <!-- Access -->
                <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.mainTabber.currentTab().id)=='access'}">
                    {% if editable %}
                    <div class="panel panel-warning" data-bind="visible: !published() && !ready_to_use()">
                        <div class="panel-heading">
                            <h3 class="panel-title">Publish</h3>
                        </div>
                        <div class="panel-body">
                            <p>At the moment, access to this {{item_type}} is restricted to members of the project this {{item_type}} belongs to and any other users you've explicitly granted access to.</p>
                            <p>Complete each of the following tasks before you publish this {{item_type}}:</p>
                            <ul class="list-unstyled" data-bind="foreach: mainTabber.tabs">
                                <li data-bind="visible: $root.task_list.section_completed[id]!==undefined">
                                <h4><a href="#" data-bind="text: title, click: $root.mainTabber.setTab(id), css: {'text-success': $root.task_list.section_completed[id], 'text-danger': !ko.unwrap($root.task_list.section_completed[id])}"></a></h4>
                                    <ul data-bind="foreach: $root.task_list.section_tasks[id]">
                                        <li data-bind="css: {'text-success': done, 'text-danger': !done()}">
                                            <span class="glyphicon" data-bind="css:{'glyphicon-ok':done, 'glyphicon-alert':!done()}"></span>
                                            <span data-bind="html: text"></span> 
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="panel panel-warning" data-bind="visible: canPublish">
                        <div class="panel-heading">
                            <h3 class="panel-title">Publish</h3>
                        </div>
                        <div class="panel-body">
                            <p>At the moment, only you can use this part type.</p>
                            <p>If you publish your part type, others will be able to use it.</p>
                            <form method="POST" id="publish-form" action="{% url 'custom_part_type_publish' object.pk %}">
                                <button class="btn btn-danger" type="submit">Publish</button>
                                {% csrf_token %}
                            </form>
                        </div>
                    </div>
                    <div class="panel panel-success" data-bind="visible: published">
                        <div class="panel-heading">
                            <h3 class="panel-title">Publish</h3>
                        </div>
                        <div class="panel-body">
                            <p>This part type has been published to the public part type database.</p>
                            <form method="POST" action="{% url 'custom_part_type_unpublish' object.pk %}">
                                <button class="btn btn-danger" type="submit">Unpublish</button>
                                {% csrf_token %}
                            </form>
                        </div>
                    </div>

                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <h3 class="panel-title">Who has access to this content?</h3>
                        </div>
                        <table class="table">
                            <thead>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>{% user_thumbnail object.author 20 15 %} {% user_link object.author new_window=True%} (Owner)</td>
                                    <td>
                                        Can edit this.
                                    </td>
                                    <td></td>
                                </tr>
                                <!-- ko foreach: {data: access_rights, afterAdd: Editor.afterAdd} -->
                                <tr>
                                    <td data-bind="html: link"></td>
                                    <td>
                                        <select class="form-control" data-bind="hasfocus: true, value: access_level, options: access_options, optionsText:'text',optionsValue:'value'"></select>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-link" data-bind="click: remove" title="Remove this user's access"><span class="glyphicon glyphicon-remove text-danger"></span></button>
                                    </td>
                                </tr>
                                <!-- /ko -->
                                <tr>
                                    <td><span class="glyphicon glyphicon-globe"></span> Anybody else</td>
                                    <td>
                                        <span data-bind="visible: ko.unwrap(published)">Can view this.</span>
                                        <span data-bind="visible: !ko.unwrap(published)">Can not view this.</span>
                                    </td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="panel-body">
                            <label>Give access to</label>
                            <input class="form-control" id="search_author" type="text" placeholder="Full name or username" size="30" data-bind="
                                value: userAccessSearch,
                                autocomplete: '{% url 'user_search' %}', 
                                autocompleteCallback: function(user) { return {label: user.name, value: user.name} },
                                autocompleteSelect: addUserAccess
                                "
                            />
                        </div>
                    </div>
                    
                    <editor-pager params="editor: $root, previousTab: 'marking', task_group: 'access'"></editor-pager>
                    {% else %}
                    {% if object.published %}
                    <p>This part type has been published to the public part type database.</p>
                    {% else %}
                    <p>This part type has not been published to the public part type database.</p>
                    {% endif %}
                    {% endif %}
                </section>
            {% endblock main_tab_content %}
            </div>
        </div>
    </div>
</div>
{% endblock content %}
