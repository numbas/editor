{% extends "editoritem/edit.html" %}
{% load user_link %}
{% load can_edit %}
{% load links %}
{% load sanitizer %}
{% load helplink %}
{% load editor_controls %}
{% load sstatic %}
{% load json_filter %}

{% block javascripts %}
    {{ block.super }}

    {% for extension in extensions %}
        {% if extension.hasScript %}
            <script src="{% sstatic extension.scriptURL %}" type="text/javascript"></script>
        {% endif %}
    {% endfor %}

    <!-- question editor -->
    <script src="{% sstatic 'js/question/part_types.js' %}" type="text/javascript"></script>
    <script src="{% sstatic 'js/question/edit.js' %}" type="text/javascript"></script>
{% endblock javascripts %}

{% block stylesheets %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% sstatic 'css/question/edit.css' %}"/>
{% endblock stylesheets %}

{% block content %}
{{block.super}}
    <div class="modal fade" id="previewModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3 class="modal-title">Preview</h3>
                </div>
                <div class="modal-body">
                    <div class="preview-content jme-scope"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary regenerate-button"><span class="glyphicon glyphicon-refresh"></span> Regenerate variables</button>
                </div>
            </div>
        </div>
        <style type="text/css" data-bind="text: Editor.makeCSSMoreSpecific(preamble.css(),'#previewModal ')"></style>
    </div>
    <div class="modal fade" id="imagePickModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3 class="modal-title">Insert image</h3>
                </div>
                <div class="modal-body">
                    <form data-bind="fileupload: resources, afterupload: $root.insertImage" data-url="{% url 'upload_resource' %}">
                        {% csrf_token %}
                        <span class="control-label">Upload a file</span>
                        <input id="fileupload" type="file" name="files[]">
                    </form>


                    <ul class="list-unstyled resources-list" data-bind="foreach: resources">
                        <li class="resource clearfix" data-bind="visible: can_embed, click: $root.insertImage">
                            <img class="thumbnail" data-bind="visible: filetype()=='img', attr: {src: url, title: name}"/>
                            <span data-bind="text: name"></span><span data-bind="visible: filetype()=='html'"> (will be embedded as an iframe)</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="imageAttributeModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3 class="modal-title">Image attributes</h3>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" data-bind="submit: Editor.noop">
                        <div class="form-group">
                            <label class="label-block">
                                <span class="col-sm-3 control-label">Width</span>
                                <div class="col-sm-9 controls">
                                    <input type="text" class="form-control" data-bind="value: imageModal.width">
                                </div>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="label-block">
                                <span class="col-sm-3 control-label">Height</span>
                                <div class="col-sm-9 controls">
                                    <input type="text" class="form-control" data-bind="value: imageModal.height">
                                </div>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="label-block">
                                <span class="col-sm-3 control-label">Title text</span>
                                <div class="col-sm-9 controls">
                                    <input type="text" class="form-control" data-bind="value: imageModal.title">
                                </div>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="label-block">
                                <span class="col-sm-3 control-label">Alt text</span>
                                <div class="col-sm-9 controls">
                                    <input type="text" class="form-control" data-bind="value: imageModal.alt">
                                </div>
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-bind="click: function(){$('#imageAttributeModal').modal('hide');}">Cancel</button>
                    <button type="button" class="btn btn-primary" data-bind="click: $root.changeImageAttributes">Apply</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="iframeAttributeModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3 class="modal-title">Embedded page attributes</h3>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" data-bind="submit: Editor.noop">
                        <div class="form-group">
                            <label class="label-block">
                                <span class="col-sm-3 control-label">Width</span>
                                <div class="col-sm-9 controls">
                                    <input type="text" class="form-control" data-bind="value: iframeModal.width">
                                </div>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="label-block">
                                <span class="col-sm-3 control-label">Height</span>
                                <div class="col-sm-9 controls">
                                    <input type="text" class="form-control" data-bind="value: iframeModal.height">
                                </div>
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-bind="click: function(){$('#iframeAttributeModal').modal('hide');}">Cancel</button>
                    <button type="button" class="btn btn-primary" data-bind="click: $root.changeIframeAttributes">Apply</button>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block settings %}
{{ block.super }}
{% if editable %}
    <editor-pager params="visible: !$root.published(), editor: $root, previousTab: 'advice', nextTab: 'access', task_group: 'settings'"></editor-pager>
{% endif %}
{% endblock settings %}

{% block admin_controls %}
{{block.super}}
<li id="add-to-basket">
<a class="basket add-to-basket" href="#" data-question-id="{{object.pk}}">
    <span class="glyphicon glyphicon-shopping-cart" aria-hidden="true"></span>&nbsp;
    <span class="hidden-sm">Add to your basket</span>
</a>
</li>
{% endblock admin_controls %}

{% block main_tab_content %}
{{ block.super }}
    <!-- Question statement -->
    <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.currentTab().id)=='statement'}, variableReferenceLandmark: {kind: 'tab', tab: 'statement'}">
        <div class="form-group">
            <label>Question statement</label>
            <div id="statement-input" {% if not editable %}disabled{% endif %} data-bind="writemaths: statement, tinymce_plugins: ['jmevisible','preview'], variableReferrer: {value: statement, description: 'Statement', kind: 'html'}"></div>
            <p class="help-block">
                {% helplink 'question/reference.html#statement' subject='the question statement' %}
                Give any introductory information the student needs. 
            </p>
        </div>

        {% if editable %}
        <editor-pager params="visible: !$root.published(), editor: $root, nextTab: 'parts', task_group: 'statement'"></editor-pager>
        {% endif %}
    </section>

    <!-- Variables -->
    <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.currentTab().id)=='variables'}">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-12 col-md-6 col-lg-7" data-bind="visible: variables().length==0">
                    <p class="nothing-here">No variables have been defined in this question.</p>
                </div>
                <div class="col-sm-12 col-md-6 col-lg-7 variable-definition" data-bind="with: currentVariable">
                    <form data-bind="submit: Editor.noop">
                        <div class="form-group">
                            <label>Name</label>
                            <input {% if not editable %}disabled{% endif %} type="text" placeholder="Name" class="form-control name monospace" data-bind="textInput: _name"/>
                            <span class="name-error text-danger" data-bind="text: nameError, visible: nameError" aria-live="polite"></span>
                        </div>
                        <div class="form-group">
                            <label>Data type</label>
                            <select {% if not editable %}disabled{% endif %} class="form-control" data-bind="options: templateTypes, value: templateType, optionsText: 'name'"></select>
                        </div>
                        <div class="form-group">
                            <label>Value</label>
                            <div data-bind="visible: templateType().id=='anything'">
                                <textarea {% if not editable %}disabled{% endif %} class="def" data-bind="codemirror: templateTypeValues.anything.definition, codemirrorMode: 'jme'"></textarea>
                                <p class="help-block text-right">
                                    <a class="helplink text-info" href="{{HELP_URL}}jme-reference.html" target="_blank">JME function reference <span class="glyphicon glyphicon-question-sign"></span></a>
                                </p>
                            </div>
                            <div data-bind="visible: templateType().id=='number'">
                                <input {% if not editable %}disabled{% endif %} class="form-control" type="text" data-bind="textInput: templateTypeValues.number.value, autosize: {max: 500, min: 30, padding: 30, value: templateTypeValues.number.value}"/> 
                                <p class="help-block">(a number)</p>
                            </div>
                            <div data-bind="visible: templateType().id=='range'" class="form-inline">
                                Numbers between 
                                <input {% if not editable %}disabled{% endif %} class="form-control" type="text" data-bind="textInput: templateTypeValues.range.min, autosize: {max: 500, min: 30, padding: 10, value: templateTypeValues.range.min}"/>
                                and
                                <input {% if not editable %}disabled{% endif %} class="form-control" type="text" data-bind="textInput: templateTypeValues.range.max, autosize: {max: 500, min: 30, padding: 10, value: templateTypeValues.range.max}"/>
                                (inclusive) with step size
                                <input {% if not editable %}disabled{% endif %} class="form-control" type="text" data-bind="textInput: templateTypeValues.range.step, autosize: {max: 500, min: 30, padding: 10, value: templateTypeValues.range.step}"/>
                            </div>
                            <div data-bind="visible: templateType().id=='randrange'" class="form-inline">
                                A random number between 
                                <input {% if not editable %}disabled{% endif %} class="form-control" type="text" data-bind="textInput: templateTypeValues.randrange.min, autosize: {max: 500, min: 30, padding: 10, value: templateTypeValues.randrange.min}"/>
                                and
                                <input {% if not editable %}disabled{% endif %} class="form-control" type="text" data-bind="textInput: templateTypeValues.randrange.max, autosize: {max: 500, min: 30, padding: 10, value: templateTypeValues.randrange.max}"/>
                                (inclusive) with step size
                                <input {% if not editable %}disabled{% endif %} class="form-control" type="text" data-bind="textInput: templateTypeValues.randrange.step, autosize: {max: 500, min: 30, padding: 10, value: templateTypeValues.randrange.step}"/>
                            </div>
                            <div data-bind="visible: templateType().id=='string'">
                                <input {% if not editable %}disabled{% endif %} class="form-control" type="text" data-bind="textInput: templateTypeValues.string.value, autosize: {max: 500, min: 30, padding: 10, value: templateTypeValues.string.value}"/> 
                                <p class="help-block">(text string)</p>
                                <p><label><input type="checkbox" data-bind="checked: templateTypeValues.string.isTemplate" {% if not editable %}disabled{% endif %}> Is this a template?</p>
                            </div>
                            <div data-bind="visible: templateType().id=='long string'">
                                <div {% if not editable %}disabled{% endif %} data-bind="writemaths: templateTypeValues['long string'].value"></div>
                                <p><label><input type="checkbox" data-bind="checked: templateTypeValues['long string'].isTemplate" {% if not editable %}disabled{% endif %}> Is this a template?</p>
                            </div>
                            <div data-bind="visible: templateType().id=='list of numbers', with: templateTypeValues['list of numbers']">
                                <ul class="list-unstyled" data-bind="foreach: values.edit">
                                    <li data-bind="css: {'has-error': value() && !Numbas.util.isNumber(value(),true)}">
                                        <input {% if not editable %}disabled{% endif %} class="form-control" type="text" data-bind="textInput: value, event: {blur: onBlur}, autosize: {max: 500, min: 30, padding: 10, value: value}"/>
                                    </li>
                                </ul>
                                <p class="help-block">(numbers)</p>
                            </div>
                            <div data-bind="visible: templateType().id=='list of strings', with: templateTypeValues['list of strings']">
                                <ul class="list-unstyled" data-bind="foreach: values.edit">
                                    <li>
                                        <input {% if not editable %}disabled{% endif %} class="form-control" type="text" data-bind="textInput: value, event: {blur: onBlur}, autosize: {max: 500, min: 30, padding: 10, value: value}"/>
                                    </li>
                                </ul>
                                <p class="help-block">(text strings)</p>
                            </div>
                            <div data-bind="visible: templateType().id=='json'">
                                <textarea {% if not editable %}disabled{% endif %} class="def" data-bind="codemirror: templateTypeValues.json.value, codemirrorMode: 'json'"></textarea>
                                <button type="button" class="btn btn-default" data-bind="click: templateTypeValues.json.prettyPrint"><span class="glyphicon glyphicon-object-align-left"></span> Clean up formatting</button>
                            </div>
                            </div>
                            <div class="help-block">
                                <div class="value-error alert alert-danger" data-bind="visible: error() && error().length>0, html: error" aria-live="polite">
                                <div class="html-type-warning value-error alert alert-danger" data-bind="visible: value() && value().type=='html'">
                                    <p>This variable is an HTML node. HTML nodes can not be relied upon to work correctly when resuming a session - for example, attached event callbacks will be lost, and mathematical notation will likely also break.</p>
                                    <p>If this causes problems, try to create HTML nodes where you use them in content areas, instead of storing them in variables.</p>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <div {% if not editable %}disabled{% endif %} data-bind="writemaths: description"></div>
                            <p class="help-block">Describe what this variable represents, and list any assumptions made about its value.</p>
                        </div>
                    </form>
                    <div data-bind="visible: dependencies().length>0" class="inline-names">
                        <label>← Depends on:</label>
                        <ul class="list-inline" data-bind="foreach: dependenciesObjects">
                            <li><span class="variable-reference btn btn-sm btn-info monospace" data-bind="click: setCurrent, text: name, css: {notdefined: notdefined}, attr: {title: title}"></span></li>
                        </ul>
                    </div>
                    <div data-bind="visible: usedIn().length>0 || references().length>0">
                        <label>→ Used by:</label>
                        <ul class="list-inline" data-bind="foreach: usedIn">
                            <li><span class="variable-reference btn btn-sm btn-info monospace" data-bind="click: $root.currentVariable, text: name"></span></li>
                        </ul>
                        <ul class="list-inline" data-bind="foreach: references">
                            <li>
                                <span class="variable-reference btn btn-sm btn-default" data-bind="click: go">
                                    <!-- ko foreach: icons --><span data-bind="attr: {'class': 'glyphicon glyphicon-'+$data}"></span> <!-- /ko -->
                                    <span data-bind="text: description"></span>
                                </span>
                            </li>
                        </ul>
                    </div>
                    <div data-bind="visible: unused" class="alert alert-info">
                        <p>This variable doesn't seem to be used anywhere.</p>
                    </div>

                </div>
                <div class="col-sm-12 col-md-6 col-lg-5">
                    <div class="panel panel-info variable-groups">
                        <!-- ko foreach: allVariableGroups -->
                        <div class="panel-heading">
                            <h3 class="panel-title">
                                {% if editable %}<button type="button" class="pull-left btn btn-xs btn-link" data-bind="click: sort" title="Sort the variables in this group"><span class="glyphicon glyphicon-sort-by-alphabet"></span></button>{% endif %}
                                <input {% if not editable %}disabled{% endif %} class="transparent-input variable-group-name" type="text" data-bind="textInput: name, attr: {readonly: fixed}"/>
                                {% if editable %}<button type="button" class="pull-right btn btn-xs btn-link" data-bind="visible: !fixed, click: remove" title="Remove this variable group"><span class="glyphicon glyphicon-remove text-danger"></span></button>{% endif %}
                            </h3>
                        </div>
                        <table class="table variable-list table-hover" data-bind="css: {empty: variables().length==0}">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th></th>
                                    <th></th>
                                    <th class="name">Name</th>
                                    <th class="type">Type</th>
                                    <th class="value">Generated Value</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody data-bind="css: {empty: variables().length==0}, sortable: {
                                foreach: $data.variables,
                                options: {
                                    group: 'variables'
                                },
                            }">
                                <tr data-bind="css: {noname: !name(), active: $data==$root.currentVariable(), dependency: isDependency, danger: anyError().length>0}" class="variable-selector">
                                    <td class="lock-cell">
                                        {% if editable %}
                                        <button type="button" class="btn btn-xs btn-link lock" data-bind="click: toggleLocked, css: {locked: locked}" title="Lock the value of this variable (editor only)">
                                            <span class="glyphicon glyphicon-lock"></span>
                                        </button>
                                        {% endif %}
                                    </td>
                                    <td class="testing-cell">
                                        <button type="button" class="btn btn-xs btn-link" title="This variable is used in the testing condition" data-bind="click: $root.setTab('variabletesting')">
                                            <span class="glyphicon glyphicon-flag" data-bind="visible: usedInTestCondition"></span>
                                        </button>
                                    </td>
                                    <td>
                                        <span title="This variable is a source of randomisation"  data-bind="visible: random(), click: $root.currentVariable" class="glyphicon glyphicon-random is-random text-muted"></span>
                                    </td>
                                    <td class="name monospace" data-bind="click: $root.currentVariable, text: name() ? name() : 'Unnamed', css: {'name-error': nameError()!='','text-danger': nameError()!=''}"></td>
                                    <td class="type" data-bind="text: type"></td>
                                    <td class="value-cell" data-bind="click: $root.currentVariable">
                                        <div class="value jme-value" data-bind="jmevalue: value, error: anyError"></div>
                                    </td>
                                    <td>
                                        {% if editable %}
                                        <button class="btn btn-xs btn-link" type="button" title="Remove this variable" data-bind="click:remove">
                                            <span class="glyphicon glyphicon-remove text-danger"></span>
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="panel-body empty-receiver" data-bind="visible: variables().length==0, sortable: {
                            foreach: $data.receivedVariables, 
                            options: {
                                group: 'variables'
                            }
                        }">
                            <span data-bind="text: $data.name"></span>
                        </div>

                        <div class="panel-footer">
                            {% if editable %}
                            <button id="add-variable-button" type="button" class="btn btn-default add-variable" data-bind="click: addVariable, attr: {title: (variables().length ? 'Add another variable' : 'Add a variable')+' to '+name()}">
                                <span class="glyphicon glyphicon-plus"></span>
                                Add a variable
                            </button>
                            {% endif %}
                        </div>

                        <!-- /ko -->
                    </div>
                    <div class="alert alert-danger" data-bind="visible: variablesTest.conditionError" aria-live="polite">
                        <h4><strong>Error in variable testing condition</strong></h4>
                        <p>There's an error in the condition you specified in the <a data-bind="click: setTab('variabletesting')" href="#">Variable testing tab</a>. Variable values can't be generated until it's fixed.</p>
                    </div>
                    <div class="fadeVisible: variables().length>0">
                        <button class="btn btn-info btn-lg btn-block" type="button" data-bind="click: generateVariablePreview"><span class="glyphicon glyphicon-refresh"></span> Regenerate values</button>
                        <div class="form-group">
                            <label class="form-block">Automatically regenerate variables? <input type="checkbox" data-bind="checked: autoCalculateVariables"></label>
                        </div>
                    </div>
                    {% if editable %}<button class="btn btn-primary btn-block" type="button" data-bind="click: addVariableGroup"><span class="glyphicon glyphicon-plus"></span> New variable group</button>{% endif %}
                </div>
            </div>
        </div>
        {% if editable %}
        <editor-pager params="visible: !$root.published(), editor: $root, previousTab: 'parts', nextTab: 'advice', task_group: 'variables'"></editor-pager>
        {% endif %}
    </section>

    <!-- Variable testing -->
    <section class="tab-pane" data-bind="css: {active: ko.unwrap(currentTab().id)=='variabletesting'}, variableReferenceLandmark: {kind: 'tab', tab: 'variabletesting'}">
        <form class="form-horizontal" data-bind="submit: Editor.noop">
            <div class="form-group">
                <label class="col-sm-3 control-label">
                    Condition to satisfy
                    {% helplink 'question/reference.html#term-condition-to-satisfy' %}
                </label>
                <div class="col-sm-9">
                    <textarea {% if not editable %}disabled{% endif %} class="def" data-bind="codemirror: variablesTest.condition, codemirrorMode: 'jme', variableReferrer: {value: variablesTest.condition, description: 'Variable testing condition', kind: 'jme'}"></textarea>
                    <p class="alert alert-danger" data-bind="visible: variablesTest.conditionError">Error: <span data-bind="html: variablesTest.conditionError" aria-live="polite"></span></p>
                </div>
            </div>
            {% with form_label_class="col-sm-3" form_control_class="col-sm-9" %}
            {% property 'variablesTest.maxRuns' 'Maximum number of runs' min=1 help_url='question/reference.html#term-maximum-number-of-runs' %}
            {% endwith %}
            <div class="form-group form-inline">
                <div class="col-sm-offset-3">
                    <p data-bind="visible: !variablesTest.running()"><button class="btn btn-primary" type="button" data-bind="click: testVariables" aria-live="polite">Test condition</button> for <input class="form-control" type="number" data-bind="textInput: variablesTest.running_time, autosize: {value:variablesTest.running_time, max:100, min: 20}"/> seconds</p>
                    <p class="variable-test-running" data-bind="visible: variablesTest.running" aria-live="polite">Running for <span data-bind="text: variablesTest.time_remaining_display"></span>... <button type="button" class="btn btn-warning" data-bind="click: cancelVariablesTest">Cancel</button></p>
                </div>
            </div>
        </form>
        <div class="variable-test-advice alert alert-info" data-bind="visible: !variablesTest.running() && variablesTest.advice(), html: variablesTest.advice" aria-live="polite"></div>
    </section>

    <!-- Parts -->
    <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.currentTab().id)=='parts'}">
        <div class="panel-group parts" role="tablist" aria-multiselectable="true">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12 col-md-8 col-lg-9 part">
                        <!-- ko if: partsTabMode()=='options' -->
                            {% include 'question/part_options.html' %}
                        <!-- /ko -->

                        <!-- ko if: partsTabMode()=='edit part' -->
                            {% include 'question/edit_part.html' %}
                        <!-- /ko -->

                        <!-- ko if: partsTabMode()=='add part' -->
                            {% include 'question/add_part.html' %}
                        <!-- /ko -->
                    </div>

                    <div class="col-sm-12 col-md-4 col-lg-3" data-bind="visible: parts().length>0">
                        <div class="panel panel-info parts-tree">
                            <div class="panel-heading">
                                <h3 class="panel-title">Parts</h3>
                            </div>
                            <div class="panel-body" data-bind="visible: partsMode().value=='explore'">
                                <a href="#" data-bind="click: showPartOptions"><span class="glyphicon glyphicon-cog"></span> Explore mode options</a>
                            </div>
                            <div class="list-group">
                                <div data-bind="sortable: {
                                    foreach: parts,
                                    options: {
                                        group: 'parts',
                                        handle: '.root'
                                    }
                                }">
                                    <div class="part-container" data-bind="css: {open: showChildren()}">
                                        <a role="button" class="list-group-item part root" data-bind="
                                            click: $parent.currentPart, 
                                            css: {
                                                active: $data==$parent.currentPart() || ($parent.addingPart() && $data==$parent.addingPart().parent)
                                            }
                                        ">
                                            <span data-bind="visible: !reachable()" class="glyphicon glyphicon-exclamation-sign text-warning" title="This part can't be reached"></span>
                                            <strong data-bind="text: header"></strong>
                                            <span class="type-name" data-bind="text: type().niceName"></span>
                                            <small class="children-description text-muted" data-bind="text: childrenDescription"></small>
                                        </a>
                                        <!-- ko if: showChildren -->
                                        <div class="children">
                                            <h4 class="children-header" data-bind="visible: canAddAlternative">Alternative answers</h4>
                                            <div class="alternatives" data-bind="visible: alternatives().length, sortable: { foreach: alternatives, options: {group: path()+'alternatives', handle: '.alternative'} }">
                                                <a role="button" class="list-group-item part alternative" data-bind="
                                                    click: $root.currentPart, 
                                                    css: {active: $data==$root.currentPart()}
                                                ">
                                                    <strong data-bind="text: name"></strong>
                                                </a>
                                            </div>
                                            <span class="list-group-item add alternative" data-bind="visible: canAddAlternative() && $data==$root.currentPart() || ($root.currentPart() && $root.currentPart().isAlternative() && $data==$root.currentPart().parent())">
                                                <button type="button" data-bind="click: addAlternative" class="btn btn-xs btn-warning"><span class="glyphicon glyphicon-plus"></span> Add an alternative answer</button>
                                            </span>
                                            <h4 class="children-header" data-bind="visible: canAddGap">Gaps</h4>
                                            <div class="gaps" data-bind="visible: gaps().length, sortable: { foreach: gaps, options: {group: path()+'gaps', handle: '.gap'} }">
                                                <div class="part-container" data-bind="css: {open: showChildren()}">
                                                    <a role="button" class="list-group-item part gap" data-bind="
                                                        click: $parents[1].currentPart, 
                                                        css: {active: $data==$parents[1].currentPart()}
                                                    ">
                                                        <strong data-bind="text: header"></strong>
                                                        <span class="type-name" data-bind="text: type().niceName"></span>
                                                        <small class="children-description text-muted" data-bind="text: childrenDescription"></small>
                                                    </a>
                                                    <!-- ko if: showChildren -->
                                                    <div class="children">
                                                        <h4 class="children-header" data-bind="visible: canAddAlternative">Alternative answers</h4>
                                                        <div class="alternatives" data-bind="visible: alternatives().length, sortable: { foreach: alternatives, options: {group: path()+'alternatives', handle: '.alternative'} }">
                                                            <a role="button" class="list-group-item part alternative" data-bind="
                                                                click: $root.currentPart, 
                                                                css: {active: $data==$root.currentPart()}
                                                            ">
                                                                <strong data-bind="text: name"></strong>
                                                            </a>
                                                        </div>
                                                        <span class="list-group-item add alternative" data-bind="visible: canAddAlternative">
                                                            <button type="button" data-bind="click: addAlternative" class="btn btn-xs btn-warning"><span class="glyphicon glyphicon-plus"></span> Add an alternative answer</button>
                                                        </span>
                                                    </div>
                                                    <!-- /ko -->
                                                </div>
                                            </div>
                                            <span class="list-group-item add gap" data-bind="visible: canAddGap">
                                                <button type="button" data-bind="click: startAddingGap" class="btn btn-xs btn-default"><span class="glyphicon glyphicon-plus"></span> Add a gap</button>
                                            </span>
                                            <h4 class="children-header" data-bind="visible: canAddStep">Steps</h4>
                                            <div class="steps" data-bind="visible: steps().length, sortable: { foreach: steps, options: {group: path()+'steps', handle: '.step'} }">
                                                <div class="part-container" data-bind="css: {open: showChildren()}">
                                                    <a role="button" class="list-group-item part step" data-bind="
                                                        click: $parents[1].currentPart, 
                                                        css: {active: $data==$parents[1].currentPart()}
                                                    ">
                                                        <strong data-bind="text: header"></strong>
                                                        <span class="type-name" data-bind="text: type().niceName"></span>
                                                    </a>
                                                    <!-- ko if: showChildren -->
                                                    <div class="children">
                                                        <h4 class="children-header" data-bind="visible: canAddAlternative">Alternative answers</h4>
                                                        <div class="alternatives" data-bind="visible: alternatives().length, sortable: { foreach: alternatives, options: {group: path()+'alternatives', handle: '.alternative'} }">
                                                            <a role="button" class="list-group-item part alternative" data-bind="
                                                                click: $root.currentPart, 
                                                                css: {active: $data==$root.currentPart()}
                                                            ">
                                                                <strong data-bind="text: name"></strong>
                                                            </a>
                                                        </div>
                                                        <span class="list-group-item add alternative" data-bind="visible: canAddAlternative">
                                                            <button type="button" data-bind="click: addAlternative" class="btn btn-xs btn-warning"><span class="glyphicon glyphicon-plus"></span> Add an alternative answer</button>
                                                        </span>
                                                    </div>
                                                    <!-- /ko -->
                                                </div>
                                            </div>
                                            <span class="list-group-item add step" data-bind="visible: canAddStep">
                                                <button type="button" data-bind="click: startAddingStep" class="btn btn-xs btn-info"><span class="glyphicon glyphicon-plus"></span> Add a step</button>
                                            </span>
                                        </div>
                                         <!-- /ko -->
                                    </div>
                                </div>
                            </div>
                            {% if editable %}
                            <div class="panel-footer">
                                <button type="button" class="btn btn-block btn-primary" data-bind="click: startAddingPart">
                                    <span class="glyphicon glyphicon-plus"></span> <span data-bind="text: parts().length ? 'Add another part' : 'Add a part'"></span>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if editable %}
        <div class="btn-group">
        </div>
        <part-type-modal params="data: addPartTypeModal"></part-type-modal>
        {% endif %}

        {% if editable %}
        <editor-pager params="visible: !$root.published(), editor: $root, previousTab: 'statement', nextTab: 'variables', task_group: 'parts'"></editor-pager>
        {% endif %}
    </section>


    <!-- Advice -->
    <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.currentTab().id)=='advice'}">
        <div class="form-group">
            <label>Advice</label>
            <div id="advice-input" {% if not editable %}disabled{% endif %} data-bind="writemaths: advice, tinymce_plugins: ['jmevisible','preview']"></div>
            <p class="help-block">
                {% helplink 'question/reference.html#advice' subject='the advice section' %}
                Give a worked solution to the whole question. 
            </p>
        </div>

        {% if editable %}
        <editor-pager params="visible: !$root.published(), editor: $root, previousTab: 'variables', nextTab: 'settings', task_group: 'advice'"></editor-pager>
        {% endif %}
    </section>

    <!-- Extensions and scripts -->
    <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.currentTab().id)=='extensions'}">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-4">
                    <div class="panel panel-info">
                        <div class="panel-heading">
                            <h4 class="panel-title">Extensions {% helplink 'question/reference.html#term-extensions' %}</h4>
                        </div>
                        <div class="panel-body">
                            <ul class="extensions" data-bind="foreach: extensions">
                                <li class="extension" data-bind="css: {error: error, 'text-warning': error}">
                                    <label>
                                        <span class="checkbox"><input type="checkbox" data-bind="checked: used_or_required, disable: !item_json.editable || required() || error(), attr: { title: required() ? 'This extension is required by one or more question parts' : '' }"></span>
                                        <span data-bind="text:name"></span> 
                                        <a data-bind="if: url, attr: {href:url, title: 'Documentation on the '+name+' extension'}" target="_blank"><small class="glyphicon glyphicon-book"></small></a>
                                        {% if not user.is_anonymous %}<a data-bind="if: author=={{user.pk}}, attr: {href: edit_url, title: 'Edit the '+name+' extension'}" target="_blank"><small class="glyphicon glyphicon-pencil"></small></a>{% endif %}
                                    </label>
                                    <div class="text-warning" data-bind="fadeVisible: error">
                                        There was an error loading this extension.
                                    </div>
                                </li>
                            </ul>
                        </div>
                        {% if editable and not user.is_anonymous %}
                        <div class="panel-footer">
                            <a class="btn btn-link btn-block" target="_blank" href="{% url 'profile_extensions' user.pk %}"><span class="glyphicon glyphicon-wrench"></span> Your extensions</a>
                        </div>
                        {% endif %}
                    </div>
                    <div class="panel panel-info">
                        <div class="panel-heading">
                            <h4 class="panel-title">Rulesets {% helplink 'question/reference.html#rulesets' subject='rulesets' %}</h4>
                        </div>
                        <ul class="list-group">
                            <!-- ko foreach: {data: rulesets, afterAdd: Editor.afterAdd} -->
                            <li class="list-group-item ruleset">
                                {% if editable %}<button type="button" class="pull-right btn btn-link btn-sm" data-bind="click:remove" title="Delete this ruleset"><span class="glyphicon glyphicon-remove"></span></button>{% endif %}
                                <div class="form-group">
                                    <label>Name</label>
                                    <input {% if not editable %}disabled{% endif %} type="text" placeholder="Name" class="name form-control" data-bind="textInput: name"/>
                                </div>
                                <div class="form-group">
                                    <label>Definition</label>
                                    <listbox params="items: sets{% if not editable %}, disabled: true{% endif %}"></listbox>
                                </div>
                            </li>
                            <!-- /ko -->
                        </ul>
                        {% if editable %}
                        <div class="panel-footer">
                            <button type="button" class="btn btn-primary" data-bind="click:addRuleset"><span class="glyphicon glyphicon-plus"></span> <span data-bind="text: rulesets().length ? 'Add another ruleset' : 'Add a ruleset'"></span></button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-sm-8">
                    <div id="functions" class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">Functions {% helplink 'question/reference.html#functions-rulesets' subject='functions' %}</h3>
                        </div>
                        <ul class="list-group">
                            <!-- ko foreach: {data: functions, afterAdd: Editor.afterAdd} -->
                            <li class="function list-group-item">
                                <div class="row">
                                    <div class="form-group col-sm-8">
                                        <label>
                                            Name {% helplink 'question/reference.html#term-name' %}
                                        </label>
                                        <input {% if not editable %}disabled{% endif %} class="form-control" placeholder="Name" type="text" data-bind="textInput: name">
                                    </div>
                                    <div class="form-group col-sm-3">
                                        <label>
                                            Language {% helplink 'question/reference.html#term-language' subject='languages' %}
                                        </label>
                                        <select {% if not editable %}disabled{% endif %} class="form-control" data-bind="options: languages, value: language"></select>
                                    </div>
                                    <div class="col-sm-1">
                                        {% if editable %}<button type="button" class="delete btn btn-sm btn-link pull-right" data-bind="click:remove" title="Delete this function"><span class="glyphicon glyphicon-remove"></span></button>{% endif %}
                                    </div>
                                </div>
                                <div class="form-group form-inline">
                                    <label>Type</label>
                                    <ul class="list-inline parameters">
                                        <!-- ko foreach: parameters -->
                                        <li class="parameter">
                                            <div class="input-group">
                                                <input {% if not editable %}disabled{% endif %} placeholder="Name" type="text" class="form-control" data-bind="textInput: name, autosize: name">
                                                <span class="input-group-btn">
                                                    <select {% if not editable %}disabled{% endif %} class="btn btn-info" data-bind="options: $parent.types, value: type" title"Type of this parameter"></select>
                                                    {% if editable %}<button type="button" class="btn btn-danger" title="Remove this parameter" data-bind="click: remove"><span class="glyphicon glyphicon-remove"></span></button>{% endif %}
                                                </span>
                                            </div>
                                        </li>
                                        <!-- /ko -->
                                        {% if editable %}
                                        <li>
                                            <button type="button" class="btn btn-xs btn-info" title="Add a parameter" data-bind="click: addParameter"><span class="glyphicon glyphicon-plus"></span></button>
                                        </li>
                                        {% endif %}
                                        <li class="output">
                                            <select {% if not editable %}disabled{% endif %} class="form-control btn-info" data-bind="options: types, value: type" title="Output type"></select>
                                        </li>
                                    </ul>
                                </div>
                                <div clas="form-group">
                                    <label>
                                        Definition:
                                    </label>
                                    <textarea {% if not editable %}disabled{% endif %} data-bind="codemirror: definition, codemirrorMode: language"></textarea>
                                    <div class="alert alert-danger" data-bind="visible: error().length>0" aria-live="polite">
                                        <span class="glyphicon glyphicon-alert"></span> <span class="errortext" data-bind="html: error"></span>
                                    </div>
                                </div>
                            </li>
                            <!-- /ko -->
                        </ul>
                        {% if editable %}
                        <div class="panel-footer">
                            <button type="button" class="btn btn-primary" data-bind="click:addFunction"><span class="glyphicon glyphicon-plus"></span> <span data-bind="text: functions().length ? 'Add another function' : 'Add a function'"></span></button>
                        </div>
                        {% endif %}
                    </div>
                    <div id="preamble" class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">
                                Preamble
                                {% helplink 'question/reference.html#preamble' %}
                            </h3>
                        </div>
                        <div class="panel-body">
                            <form data-bind="submit: Editor.noop">
                                <div class="form-group">
                                    <label>Javascript</label>
                                    <textarea {% if not editable %}disabled{% endif %} data-bind="codemirror: preamble.js, codemirrorMode: 'javascript'"></textarea>
                                    <div class="help-block">
                                        This script will run after the question's variable have been generated but before the HTML is attached.
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>CSS</label>
                                    <textarea {% if not editable %}disabled{% endif %} data-bind="codemirror: preamble.css, codemirrorMode: 'css'"></textarea>
                                    <div class="help-block">
                                        Apply styling rules to the question's content.
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Resources -->
    <section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='resources'}">
        {% if editable %}
        <form class="alert alert-info" data-bind="fileupload: resources" data-url="{% url 'upload_resource' %}">
            {% csrf_token %}
            <h4 class="control-label">Upload a file</h4>
            <p><input id="fileupload" type="file" name="files[]"></p>
        </form>
        {% endif %}
        <ul class="media-list" data-bind="foreach: resources">
            <li class="media resource">
                {% if editable %}<button type="button" class="pull-left btn btn-lg btn-link text-warning delete" data-bind="click: $root.deleteResource" title="Delete this resource"><span class="glyphicon glyphicon-remove"></span></button>{% endif %}
                <div class="media-left">
                    <div data-bind="visible: progress()<1" class="progress progress-striped active">
                        <div class="bar" data-bind="style: {width: progress()+'%'}"></div>
                    </div>
                    <div data-bind="visible: progress()==1">
                        <a data-bind="attr: {href: url}" target="_blank"><img class="thumbnail" data-bind="visible: filetype()=='img', attr: {src: url, title: name}"/></a>
                    </div>
                </div>
                <div class="media-body">
                    <label>URL:</label>
                    <code class="path monospace" data-bind="visible: progress()==1, text: 'resources/'+name()"></code>
                </div>
            </li>
        </ul>
    </section>

    <!-- Exams using this question -->
    <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.currentTab().id)=='exams'}">
        {% if object.exams_using_this.count %}
        <p>This question is used in the following exam{{object.exams_using_this.count|pluralize}}:</p>
            <ul class="exams-list">
            {% for exam in object.exams_using_this.all %}
                <li class="exam">
                    <a href="{% url 'exam_edit' exam.pk exam.editoritem.slug %}">{{exam.editoritem.name}}</a> by {% user_link exam.editoritem.author %} in <a href="{% url 'project_index' exam.editoritem.project.pk %}">{{exam.editoritem.project.name}}</a>.
                </li>
            {% endfor %}
            </ul>
        {% else %}
            This question is not used in any exams.
        {% endif %}
    </section>

{% endblock main_tab_content %}

{% block access_tab_nav %}
    <editor-pager params="visible: !$root.published(), editor: $root, previousTab: 'settings', task_group: 'access'"></editor-pager>
{% endblock access_tab_nav %}
